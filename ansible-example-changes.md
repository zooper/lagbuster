# Ansible Configuration Changes for Lagbuster Integration

> **Note**: This guide contains examples from a real deployment using router-jc01 and specific variable names. Adapt the examples to match your own Ansible inventory and Bird configuration.

This document describes the changes needed in your Ansible Bird configuration to integrate with Lagbuster.

## Overview

Lagbuster needs to control Bird BGP priorities dynamically. To achieve this safely:
1. Ansible creates an initial `lagbuster-priorities.conf` file with default priorities
2. Ansible modifies `ibgp_edge.conf` to use lagbuster priority variables
3. Lagbuster updates the priorities file at runtime
4. After reboot, Ansible defaults are restored, then Lagbuster re-optimizes

## Required Changes

### 1. Create New Template: `lagbuster-priorities.conf.j2`

**Location**: `/Users/jonsson/dev/private/bird/ansible/templates/lagbuster-priorities.conf.j2`

```jinja2
# Lagbuster dynamic priority overrides
# This file is managed by lagbuster at runtime
# Initial values are set by Ansible, then updated dynamically based on latency monitoring
#
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# Host: {{ inventory_hostname }}

{% if ibgp_edge_peers is defined %}
{% for peer in ibgp_edge_peers %}
# {{ peer.name }}: {{ peer.description }} (default priority: {{ peer.priority }})
define {{ peer.name | lower }}_lagbuster_priority = {{ peer.priority }};
{% endfor %}
{% endif %}
```

### 2. Modify Template: `ibgp_edge.conf.j2`

**Location**: `/Users/jonsson/dev/private/bird/ansible/templates/ibgp_edge.conf.j2`

**Changes needed:**

```jinja2
# iBGP edge peers (core â†” edge with priority system)

# Include lagbuster dynamic priorities
# This file is updated at runtime by lagbuster
include "lagbuster-priorities.conf";

{% if ibgp_edge_peers is defined %}
{% for peer in ibgp_edge_peers %}
# ---- {{ peer.name }} ----
# Priority system: 1=primary, 2=secondary, 3=tertiary, etc. (0=disabled)
# NOTE: Priority is now controlled by lagbuster via {{ peer.name | lower }}_lagbuster_priority

template bgp TPL_{{ peer.name }} {
    ipv6 {
        # Import filter: drop unwanted ASNs, set local_pref based on priority
        import filter {
            if !should_accept_asn() then reject;

            # CHANGED: Use lagbuster_priority variable instead of priority
            if {{ peer.name | lower }}_lagbuster_priority = 1 then {
                bgp_local_pref = 130;      # Primary
            } else if {{ peer.name | lower }}_lagbuster_priority = 2 then {
                bgp_local_pref = 120;      # Secondary
            } else if {{ peer.name | lower }}_lagbuster_priority = 3 then {
                bgp_local_pref = 110;      # Tertiary
            } else {
                bgp_local_pref = 90;       # Default/disabled
            }
            accept;
        };

        # Export filter: only export selected prefixes, add community if backup
        export filter {
            if is_in_announced_prefixes() then {
                # CHANGED: Use lagbuster_priority variable
                if {{ peer.name | lower }}_lagbuster_priority = 2 then {
                    bgp_large_community.add(({{ own_asn }}, 100, 2));  # Secondary: 4x prepending
                } else if {{ peer.name | lower }}_lagbuster_priority = 3 then {
                    bgp_large_community.add(({{ own_asn }}, 100, 3));  # Tertiary: 6x prepending
                } else if {{ peer.name | lower }}_lagbuster_priority = 0 then {
                    bgp_large_community.add(({{ own_asn }}, 100, 0));  # Disabled: 8x prepending
                }
                # Priority 1 gets no community (no prepending)
                accept;
            }
            reject;
        };

        next hop self;
    };
    local as {{ own_asn }};
}

protocol bgp {{ peer.name }} from TPL_{{ peer.name }} {
    description "{{ peer.description }}";
    neighbor {{ peer.neighbor }} as {{ own_asn }};
    source address {{ peer.source_address }};
}

{% endfor %}
{% endif %}
```

**Summary of changes in `ibgp_edge.conf.j2`:**
1. Add `include "lagbuster-priorities.conf";` at the top
2. Remove all `define {{ peer.name | lower }}_priority = X;` lines (now in lagbuster-priorities.conf)
3. Replace all references to `{{ peer.name | lower }}_priority` with `{{ peer.name | lower }}_lagbuster_priority`

### 3. Update Ansible Playbook: `deploy-bird.yml`

**Location**: `/Users/jonsson/dev/private/bird/ansible/deploy-bird.yml`

Add a task to deploy the lagbuster-priorities.conf template:

```yaml
# Add this task in the appropriate place (after other Bird config templates)

- name: Deploy lagbuster priorities configuration
  template:
    src: lagbuster-priorities.conf.j2
    dest: "{{ bird_config_path }}/lagbuster-priorities.conf"
    owner: root
    group: root
    mode: '0644'
  notify: reload bird
  tags:
    - bird
    - bird-config
```

## Verification Steps

After making these changes:

### 1. Test Ansible Deployment (Dry-Run)

```bash
cd /Users/jonsson/dev/private/bird/ansible
ansible-playbook -i inventory.yml deploy-bird.yml --check --diff -l router-jc01
```

Verify:
- `lagbuster-priorities.conf` will be created
- `ibgp_edge.conf` includes the lagbuster file
- Variable names changed from `*_priority` to `*_lagbuster_priority`

### 2. Deploy to Router

```bash
ansible-playbook -i inventory.yml deploy-bird.yml -l router-jc01
```

### 3. Verify Bird Configuration

SSH to router-jc01 and verify:

```bash
# Check files exist
ls -la /etc/bird/lagbuster-priorities.conf
ls -la /etc/bird/ibgp_edge.conf

# Verify Bird can parse the config
sudo birdc configure check

# Check current priority values
cat /etc/bird/lagbuster-priorities.conf

# Verify variables are defined in Bird
echo 'show symbols' | sudo birdc | grep lagbuster_priority
```

Expected output:
```
jc01_nyc01_lagbuster_priority	constant
jc01_nyc02_lagbuster_priority	constant
jc01_ash01_lagbuster_priority	constant
```

### 4. Check Variable Values

```bash
echo 'eval jc01_nyc01_lagbuster_priority' | sudo birdc
echo 'eval jc01_nyc02_lagbuster_priority' | sudo birdc
echo 'eval jc01_ash01_lagbuster_priority' | sudo birdc
```

Should show the default priorities (1, 3, 2 based on your current config).

## Rollback Plan

If something goes wrong:

```bash
# On router-jc01, restore backup
sudo cp /etc/bird/ibgp_edge.conf.backup /etc/bird/ibgp_edge.conf
sudo birdc configure

# Or just restart Bird to load last known-good config
sudo systemctl restart bird
```

## Testing Lagbuster After Ansible Changes

Once Ansible changes are deployed:

1. **Test lagbuster in dry-run mode:**
   ```bash
   sudo /opt/lagbuster/lagbuster -dry-run
   ```

2. **Manually trigger a priority change:**
   ```bash
   # Edit the lagbuster-priorities.conf to simulate lagbuster changes
   sudo tee /etc/bird/lagbuster-priorities.conf > /dev/null <<'EOF'
   # Test: Switch primary to ASH01
   define jc01_nyc01_lagbuster_priority = 2;
   define jc01_nyc02_lagbuster_priority = 3;
   define jc01_ash01_lagbuster_priority = 1;
   EOF
   
   # Reload Bird
   sudo birdc configure
   
   # Verify change took effect
   echo 'eval jc01_ash01_lagbuster_priority' | sudo birdc  # Should show 1
   ```

3. **Check BGP local preferences:**
   ```bash
   # Show routes and their local_pref values
   echo 'show route all' | sudo birdc | grep -A5 "local_pref"
   ```

4. **Start lagbuster:**
   ```bash
   sudo systemctl start lagbuster
   sudo journalctl -u lagbuster -f
   ```

## Summary of File Changes

| File | Change Type | Description |
|------|-------------|-------------|
| `templates/lagbuster-priorities.conf.j2` | NEW | Initial priority values template |
| `templates/ibgp_edge.conf.j2` | MODIFY | Include lagbuster file, use `*_lagbuster_priority` variables |
| `deploy-bird.yml` | MODIFY | Add task to deploy lagbuster-priorities.conf |

## Important Notes

1. **Ansible can still run safely**: The lagbuster-priorities.conf file is regenerated each Ansible run with defaults, but lagbuster will re-optimize after any Bird reload.

2. **Reboot behavior**: After reboot, Bird loads Ansible defaults, then lagbuster (via systemd) re-optimizes based on current latency.

3. **Manual overrides**: You can always manually edit `/etc/bird/lagbuster-priorities.conf` and reload Bird to override lagbuster temporarily. Next lagbuster cycle will revert to its decision.

4. **Ansible won't break lagbuster**: If you run Ansible, it will reset priorities to defaults, but lagbuster will detect this and re-optimize within minutes.

## Questions?

If you encounter issues with the Ansible integration, check:
- Variable name consistency (`*_lagbuster_priority` everywhere)
- Include statement path is correct (`lagbuster-priorities.conf` not `/etc/bird/lagbuster-priorities.conf`)
- File permissions (Bird needs to read lagbuster-priorities.conf)
- Syntax errors with `birdc configure check`
